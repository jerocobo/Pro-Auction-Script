<?php/******************************************************************************* *   copyright				: (C) 2014 - 2018 Pro-Auction-Script *   site					: https://www.pro-auction-script.com *   Script License			: https://www.pro-auction-script.com/contents.php?show=free_license *******************************************************************************/include 'common.php';unset($ERROR);if ($system->SETTINGS['boards'] == 'n'){	header('location: home');}// Is the seller logged in?if (!$user->checkAuth()){	$_SESSION['REDIRECT_AFTER_LOGIN'] = 'boards.php';	header('location: user_login.php');	exit;}include PLUGIN_PATH . 'htmLawed/htmLawed.php';$conf = array();$conf = $system->SETTINGS['htmLawed_safe'];$conf = $system->SETTINGS['htmLawed_deny_attribute'];include PLUGIN_PATH . 'ckeditor/ckeditor.php';$CKEditor = new CKEditor();$CKEditor->basePath = $system->SETTINGS['siteurl'] . 'includes/plugins/ckeditor/';$CKEditor->returnOutput = true;$CKEditor->config['width'] = '100%';$CKEditor->config['height'] = 200;if (isset($_POST['board_id'])){	$board_id = intval($_POST['board_id']);}elseif (isset($_GET['board_id'])){	$board_id = intval($_GET['board_id']);}if (!isset($board_id) || is_array($board_id) || empty($board_id) || $board_id == 0){	header('location: boards.php');	exit;}$NOW = $system->CTIME;$query = "SELECT id FROM " . $DBPrefix . "comm_messages WHERE boardid = :board_id AND user = :user_id";$params = array(	array(':board_id', $board_id, 'int'),	array(':user_id', $user->user_data['id'], 'int'));$db->query($query, $params);if (isset($_POST['action']) && empty($_POST['newmessage'])){	$ERROR = $ERR['624'];}$TOTALMSGS = $db->numrows();// Insert new message in the databaseif (isset($_POST['action']) && $_POST['action'] == 'insertmessage' && !empty($_POST['newmessage'])) {	if ($system->SETTINGS['wordsfilter'] == 'y')	{		$message = $system->filter($_POST['newmessage']);	}	else	{		$message = $_POST['newmessage'];	}	$query = "INSERT INTO " . $DBPrefix . "comm_messages VALUES (NULL, :board_id, :now, :user_id, :user_nick, :message)";	$params = array(		array(':board_id', intval($_POST['board_id']), 'int'),		array(':now', $NOW, 'int'),		array(':user_id', $user->user_data['id'], 'int'),		array(':user_nick', $user->user_data['nick'], 'int'),		array(':message', htmLawed($message,$conf), 'int')	);	$db->query($query, $params);	// Track IP	if (defined('TrackUserIPs'))	{		$system->log('user', 'Post Public Message', $user->user_data['id'], $db->lastInsertId());	}	// Update messages counter and lastmessage date	$query = "UPDATE " . $DBPrefix . "community SET messages = messages + :one, lastmessage = :now WHERE id = :board_id";	$params = array(		array(':one', '1', 'int'),		array(':now', $NOW, 'int'),		array(':board_id', $board_id, 'int')	);	$db->query($query, $params);	header('location: ' . $_SERVER['HTTP_REFERER']);}// retrieve message board title$query = "SELECT name, active, msgstoshow FROM " . $DBPrefix . "community WHERE id = :board_id";$params = array(	array(':board_id', $board_id, 'int'));$db->query($query, $params);$info = $db->result();$BOARD_TITLE = $info['name'];$BOARD_ACTIVE = $info['active'];$BOARD_LIMIT = $info['msgstoshow'];if (!isset($_GET['PAGE'])){	$OFFSET = 0;	$PAGE = 1;}else{	$PAGE = $_GET['PAGE'];	$OFFSET = ($PAGE - 1) * $BOARD_LIMIT;}$PAGES = ceil($TOTALMSGS / $BOARD_LIMIT);if (!$PAGES) $PAGES = 1;if ($BOARD_ACTIVE == 2){	header('location: boards.php');	exit;}if (isset($_GET['show']) && $_GET['show'] == 'all'){	$SQL_LIMIT = '';}else{	$SQL_LIMIT = " LIMIT $OFFSET, $BOARD_LIMIT";}// Retrieve messages for this message board$query = "SELECT * FROM " . $DBPrefix . "comm_messages WHERE boardid = :board_id ORDER BY msgdate DESC $SQL_LIMIT";$params = array(	array(':board_id', $board_id, 'int'));$db->query($query, $params);if ($db->numrows() > 0){	$k = 0;	while ($messages = $db->result())	{		$template->assign_block_vars('msgs', array(				'MSG' => nl2br(stripslashes($messages['message'])),				'USERNAME' => $messages['username'],				'POSTED' => $system->dateToTimestamp($messages['msgdate']),				'BGCOLOR' => (!($k % 2)) ? '' : 'class="alt-row"',				));		$k++;	}}$PREV = intval($PAGE - 1);$NEXT = intval($PAGE + 1);if ($PAGES > 1){	$LOW = $PAGE - 5;	if ($LOW <= 0) $LOW = 1;	$COUNTER = $LOW;	while ($COUNTER <= $PAGES && $COUNTER < ($PAGE + 6))	{		$template->assign_block_vars('pages', array(				'PAGE' => ($PAGE == $COUNTER) ? '<li class="disabled"><a href="#">' . $COUNTER . '</a></li>' : '<li><a href="' . $system->SETTINGS['siteurl'] . 'msgboard.php?PAGE=' . $COUNTER . '&board_id=' . $board_id . '">' . $COUNTER . '</a></li>'				));		$COUNTER++;	}}// Count message$query = "SELECT id FROM " . $DBPrefix . "comm_messages";$db->direct_query($query);$COUNT = $db->numrows();$template->assign_vars(array(	'ERROR' => (isset($ERROR)) ? $ERROR : '',	'BOARD_NAME' => $BOARD_TITLE,	'BOARD_ID' => $board_id,	'BOARDMSG' => $CKEditor->editor('newmessage', ''),	'PREV' => ($PAGES > 1 && $PAGE > 1) ? '<li><a href="' . $system->SETTINGS['siteurl'] . 'msgboard.php?PAGE=' . $PREV . '&board_id=' . $board_id . '">' . $MSG['5119'] . '</a></li>' : '',	'NEXT' => ($PAGE < $PAGES) ? '<li><a href="' . $system->SETTINGS['siteurl'] . 'msgboard.php?PAGE=' . $NEXT . '&board_id=' . $board_id . '">' . $MSG['5120'] . '</a></li>' : '',	'PAGE' => $PAGE,	'PAGES' => $PAGES,	'ACTIVEACCOUNTTAB' => 'class="active"',	'ACTIVEBOARDS' => 'class="active"',	'ACTIVEACCOUNTPANEL' => 'active'));// Build the bottom navigation line for the templateif ($COUNT > $BOARD_LIMIT && (!isset($_GET['show']) || $_GET['show'] != 'all')){	$NAVIGATION = '<a href="' . $system->SETTINGS['siteurl'] . 'msgboard.php?show=all&offset=' . $_REQUEST['offset'] . '&board_id=' . $_REQUEST['board_id'] . '">' . $MSG['5062'] . '</a> (' . $COUNT . ')';}elseif ($_GET['show'] == 'all'){	$NAVIGATION = '<a href="' . $system->SETTINGS['siteurl'] . 'msgboard.php?board_id=' . $_REQUEST['board_id'] . '&offset=' . $_REQUEST['offset'] . '">&lt;&lt; ' . $MSG['270'] . '</a> ';}else{	$NAVIGATION = '';}include 'header.php';$template->set_filenames(array(		'body' => 'msgboard.tpl'		));$template->display('body');include 'footer.php';