<?php/******************************************************************************* *   copyright				: (C) 2014 - 2018 Pro-Auction-Script *   site					: https://www.pro-auction-script.com *   Script License			: https://www.pro-auction-script.com/contents.php?show=free_license *******************************************************************************/include 'common.php';if (!$user->checkAuth()){	$_SESSION['REDIRECT_AFTER_LOGIN'] = 'email_request.php';	header('location: user_login.php');	exit;}$item_title = '';$auction_id = '';include PLUGIN_PATH . 'htmLawed/htmLawed.php';$conf = array();$conf = $system->SETTINGS['htmLawed_safe'];$conf = $system->SETTINGS['htmLawed_deny_attribute'];include PLUGIN_PATH . 'ckeditor/ckeditor.php';$CKEditor = new CKEditor();$CKEditor->basePath = $system->SETTINGS['siteurl'] . 'includes/plugins/ckeditor/';$CKEditor->returnOutput = true;$CKEditor->config['width'] = '100%';$CKEditor->config['height'] = '200px';// Get auction_id from sessions variablesif (isset($_GET['auction_id'])){	$auction_id = $_SESSION['ITEM'] = intval($_GET['auction_id']);}elseif (isset($_SESSION['ITEM'])){	$auction_id = $_SESSION['ITEM'];}if(isset($auction_id)){	$query = "SELECT title FROM " . $DBPrefix . "auctions WHERE id = :auc_id";	$params = array(		array(':auc_id', $auction_id, 'int')	);	$db->query($query, $params);	if ($db->numrows() > 0)	{		$TPL_item_title = $db->result('title');		$item_title = $MSG['336'] .  ' ' . $system->uncleanvars($TPL_item_title);	}}$query = "SELECT id, email, nick FROM " . $DBPrefix . "users WHERE id = :user_id";$params = array(	array(':user_id', intval($_GET['user_id']), 'int'));$db->query($query, $params);$user_info = $db->result();$user_id = $user_info['id'];$email = $user_info['email'];$username = $user_info['nick'];$sent = false;if (isset($_POST['action']) && $_POST['action'] == 'proceed'){	if (empty($_POST['TPL_text']))	{		$ERROR = $ERR['031'];	}	else	{		$from_email = ($system->SETTINGS['users_email'] == 'n') ? $user->user_data['email'] : $system->SETTINGS['adminmail'];		// Send e-mail message		$subject = $MSG['335'] . ' ' . $system->SETTINGS['sitename'] . ' ' . $item_title;		$message = $MSG['084'] . ' ' . $MSG['240'] . ': ' . $from_email . "\n\n" . $_POST['TPL_text'];					//send sms alert the user		$optionSettings = array(			'userID' => $user_id,		);		$smsAlerts->alertSettingHandler('newMessageAlert',$optionSettings);		$send_email->email_request($user_id, $subject, $email, $message, $user->user_data['name'], $from_email);								// send a copy to their mesasge box		$nowmessage = nl2br($system->cleanvars($message));		$query = "INSERT INTO " . $DBPrefix . "messages (id, sentto, sentfrom, fromemail, sentat, message, isread, subject, replied, reply_of, question, public)			VALUES (NULL, :memberid, :user_id, :from_email, :times, :nowmessage, 0, :msg, 0, 0, 0, 0)";		$params = array(			array(':memberid', $user_id, 'int'),			array(':user_id', $user->user_data['id'], 'int'),			array(':from_email', $from_email, 'str'),			array(':times', $system->CTIME, 'int'),			array(':nowmessage', $system->cleanvars(htmLawed($nowmessage,$conf)), 'str'),			array(':msg', $system->cleanvars(sprintf($MSG['651'], $item_title)), 'str')		);		$db->query($query, $params);		$sent = true;	}}$template->assign_vars(array(		'B_SENT' => $sent,		'ERROR' => (isset($ERROR)) ? $ERROR : '',		'USERID' => $user_id,		'B_FB_LINK' => 'IndexFBLogin',		'USERNAME' => $username,		'AUCTION_ID' => $auction_id !='' ? '&auction_id=' . $auction_id : '',		'B_AUCTION_ID' => isset($auction_id) ?true : false,				'MSG_TEXT' => (isset($_POST['TPL_text'])) ? $CKEditor->editor('TPL_text', stripslashes($_POST['TPL_text'])) : $CKEditor->editor('TPL_text', ''),		));include 'header.php';$template->set_filenames(array(		'body' => 'email_request.tpl'		));$template->display('body');include 'footer.php';