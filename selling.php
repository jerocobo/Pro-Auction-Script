<?php/******************************************************************************* *   copyright				: (C) 2014 - 2018 Pro-Auction-Script *   site					: https://www.pro-auction-script.com *   Script License			: https://www.pro-auction-script.com/contents.php?show=free_license *******************************************************************************/include 'common.php';// If user is not logged in redirect to login pageif (!$user->checkAuth()){	$_SESSION['REDIRECT_AFTER_LOGIN'] = 'selling.php';	header('location: user_login.php');	exit;}include INCLUDE_PATH . 'auction/class_item_setting.php';$ItemStatus = new ItemSettings();//set item shipped$update = false;if (isset($_POST['update']) && $_POST['update'] == 'paid') {	$ItemStatus->UpdatePaidStatus();	$update = true;}elseif (isset($_POST['update']) && $_POST['update'] == 'shipped') {	$ItemStatus->UpdateShippingStatus(1,'seller');	$update = true;}elseif (isset($_POST['update']) && $_POST['update'] == 'addTracking') {	$ItemStatus->AddTrackingInfo();	$update = true;}//checking to see if the ID is being used$wid = (isset($_GET['id'])) ? intval($_GET['id']) : false;//prevent users from refreshing the pages to change the DBif ($update == true){	if(!empty($wid))	{		header('location: selling.php?id=' . $wid);		exit;	}	else	{		header('location: selling.php');		exit;	}}//checking if the ID is used$params = array();if (isset($wid)){	$searchid = ' AND a.id = :auc_id ';	$params[] = array(':auc_id', $wid, 'int');}else{	$searchid = ' ';}// Retrieve active auctions from the database$query = "SELECT w.id FROM " . $DBPrefix . "auctions a LEFT JOIN " . $DBPrefix . "winners w ON (w.auction = a.id)	WHERE (a.closed = 1 OR a.bn_only = 'y') AND a.user = :seller_id" . $searchid . "ORDER BY w.closingdate DESC";$params[] = array(':seller_id', $user->user_data['id'], 'int');$db->query($query, $params);$TOTALAUCTIONS = $db->numrows();if (!isset($_GET['PAGE']) || $_GET['PAGE'] <= 1 || $_GET['PAGE'] == ''){	$OFFSET = 0;	$PAGE = 1;}else{	$PAGE = intval($_GET['PAGE']);	$OFFSET = ($PAGE - 1) * $system->SETTINGS['perpage'];}$PAGES = ($TOTALAUCTIONS == 0) ? 1 : ceil($TOTALAUCTIONS / $system->SETTINGS['perpage']);// Get closed auctions with winners$query = "SELECT a.title, a.auction_type, a.ends, w.*, u.nick FROM " . $DBPrefix . "auctions a 	LEFT JOIN " . $DBPrefix . "winners w ON (w.auction = a.id) 	LEFT JOIN " . $DBPrefix . "users u ON (u.id = w.winner) 	WHERE a.user = :seller_id AND (a.closed = 1 OR a.bn_only = 'y')" . $searchid . "ORDER BY w.closingdate DESC LIMIT :offset, :perpage";$params[] = array(':seller_id', $user->user_data['id'], 'int');$params[] = array(':offset', $OFFSET, 'int');$params[] = array(':perpage', $system->SETTINGS['perpage'], 'int');$db->query($query, $params);$i = 0;$shippingStatus = true;while ($row = $db->fetch()){	$i++;	if ((isset($wid) > 0) && $row['is_read'] == 0)	{		$ItemStatus->UpdateReadStatus($wid, $row['seller']);	}		$query = "SELECT hash, item FROM " . $DBPrefix . "digital_items WHERE auctions = :auc_id";	$params = array(		array(':auc_id', $row['auction'], 'int')	);	$db->query($query, $params);	$digitalItem = $db->result();	if(isset($digitalItem['item'])) {		$shippingStatus = false;	}	$template->assign_block_vars('a', array(		'TITLE' => $row['title'],		'COUNTER' => $i,		'ENDS' => $system->dateToTimestamp($row['closingdate']),		'SEO_TITLE' => generate_seo_link($row['title']),		'AUCTIONID' => $row['auction'],		'BGCOLOR' => (!($i % 2)) ? '' : 'class="warning"',		'ID' => $row['id'],		'BIDF' => $system->print_money($row['bid']),		'QTY' => (!empty($digitalItem['item'])) ? 1 : $row['qty'],		'NICK' => $row['nick'],		'WINNERID' => $row['winner'],		'SELLERID' => $row['seller'],		'DIGITAL_ITEM' => $security->encrypt($digitalItem['hash']),			'SHIPPER' => isset($row['shipper']) ? $row['shipper'] : '',		'SHIPPERURL' => isset($row['shipper_url']) ? $row['shipper_url'] : '',		'TRACKINGNUMBER' => isset($row['tracking_number']) ? $row['tracking_number'] : '',		'B_SHIPPER' => $row['auction_type'] < 3 ? true : false,		'B_SHIPPED_0' => ($row['shipped'] == 0) ? true : false,		'B_SHIPPED_1' => ($row['shipped'] == 1) ? true : false,		'B_SHIPPED_2' => ($row['shipped'] == 2) ? true : false,			'B_DIGITAL_ITEM' => (isset($digitalItem['item'])),		'B_PAID' => ($row['paid'] == 1),		'B_FB' => ($row['feedback_sel'] == 0) ? true : false,		'MARK_PAID_MSG' => sprintf($MSG['3500_1015534'], '( ' . $row['title'] . ' )'),		'MARK_SHIPPED_MSG' => sprintf($MSG['3500_1015535'], '( ' . $row['title'] . ' )')	));}// get pagenation$PREV = intval($PAGE - 1);$NEXT = intval($PAGE + 1);if ($PAGES > 1){	$LOW = $PAGE - 5;	if ($LOW <= 0) $LOW = 1;	$COUNTER = $LOW;	while ($COUNTER <= $PAGES && $COUNTER < ($PAGE + 6))	{		$template->assign_block_vars('pages', array(			'PAGE' => ($PAGE == $COUNTER) ? '<li class="disabled"><a href="#">' . $COUNTER . '</a></li>' : isset($wid) ? '<li><a href="' . $system->SETTINGS['siteurl'] . 'selling.php?id=' . $wid . '&PAGE=' . $COUNTER . '">' . $COUNTER . '</a></li>' : '<li><a href="' . $system->SETTINGS['siteurl'] . 'selling.php?PAGE=' . $COUNTER . '">' . $COUNTER . '</a></li>'		));		$COUNTER++;	}}$template->assign_vars(array(	'PREV' => ($PAGES > 1 && $PAGE > 1) ? isset($wid) ? '<a href="' . $system->SETTINGS['siteurl'] . 'selling.php?id=' . $wid . '&PAGE=' . $PREV . '"><u>' . $MSG['5119'] . '</u></a>&nbsp;&nbsp;' : '<a href="' . $system->SETTINGS['siteurl'] . 'selling.php?PAGE=' . $PREV . '">' . $MSG['5119'] . '</a>' : '',	'NEXT' => ($PAGE < $PAGES) ? isset($wid) ? '<a href="' . $system->SETTINGS['siteurl'] . 'selling.php?id=' . $wid . '&PAGE=' . $NEXT . '"><u>' . $MSG['5120'] . '</u></a>' : '<a href="' . $system->SETTINGS['siteurl'] . 'selling.php?PAGE=' . $NEXT . '">' . $MSG['5120'] . '</a>' : '',	'PAGE' => $PAGE,	'PAGES' => $PAGES,	'NUM_WINNERS' => $i,	'SELLER_ID' => $user->user_data['id'],	'ACTIVESELLINGTAB' => 'class="active"',	'ACTIVESOLDAUCTIONS' => 'class="active"',	'ACTIVESELLINGPANEL' => 'active',	'B_DIGITAL_ITEM' => (isset($digitalItem['item']))));include 'header.php';$template->set_filenames(array(		'body' => 'selling.tpl'		));$template->display('body');include 'footer.php';