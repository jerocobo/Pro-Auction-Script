<?php/******************************************************************************* *   copyright				: (C) 2014 - 2018 Pro-Auction-Script *   site					: https://www.pro-auction-script.com *   Script License			: https://www.pro-auction-script.com/contents.php?show=free_license *******************************************************************************/include 'common.php';$NOW = $system->CTIME;$NOWB = date('Ymd');// If user is not logged in redirect to login pageif (!$user->checkAuth()){	$_SESSION['REDIRECT_AFTER_LOGIN'] = 'yourauctions_p.php';	header('location: user_login.php');	exit;}// DELETE OR CLOSE OPEN AUCTIONSif (isset($_POST['action']) && $_POST['action'] == 'delopenauctions'){	if (is_array($_POST['O_delete']) && count($_POST['O_delete']) > 0)	{		$removed = 0;		foreach ($_POST['O_delete'] as $k => $v)		{			$v = intval($v);			// Pictures Gallery			if(is_dir(UPLOAD_PATH . $v))			{				if ($dir = @opendir(UPLOAD_PATH . '/' . $v))				{					while ($file = readdir($dir))					{						if ($file != '.' && $file != '..')						{							@unlink(UPLOAD_PATH . '/' . $v . $file);						}					}					closedir($dir);					@rmdir(UPLOAD_PATH . '/' . $v);				}			}			// Delete Invited Users List and Black Lists associated with this auction			$query = "DELETE FROM " . $DBPrefix . "auccounter WHERE auction_id = :auc_id";			$params = array(				array(':auc_id', $v, 'int')			);			$db->query($query, $params);			// Auction			$query = "DELETE FROM " . $DBPrefix . "auctions WHERE id = :auc_id";			$params = array(				array(':auc_id', $v, 'int')			);			$db->query($query, $params);			$removed++;		}		$system->writesetting("counters", "auctions", $system->COUNTERS['auctions'] - removed, 'int');	}	if (is_array($_POST['startnow']))	{		foreach ($_POST['startnow'] as $k => $v)		{			$query = "SELECT duration FROM " . $DBPrefix . "auctions WHERE id = :auc_id";			$params = array(				array(':auc_id', $v, 'int')			);			$db->query($query, $params);			$data = $db->result('duration');			$ends = $NOW + ($data['duration'] * 24 * 60 * 60);			// Update end time to "now"			$query = "UPDATE " . $DBPrefix . "auctions SET starts = :now, ends = :end WHERE id = :auc_id";			$params = array(				array(':now', $NOW, 'int'),				array(':end', $ends, 'int'),				array(':auc_id', $v, 'int')			);			$db->query($query, $params);		}	}}// Retrieve active auctions from the database$query = "SELECT count(id) AS COUNT FROM " . $DBPrefix . "auctions WHERE user = :user_id and starts > :now AND suspended = :suspend";$params = array(	array(':user_id', $user->user_data['id'], 'int'),	array(':now', $NOW, 'int'),	array(':suspend', 0, 'int'));$db->query($query, $params);$TOTALAUCTIONS = $db->result('COUNT');if (!isset($_GET['PAGE']) || $_GET['PAGE'] < 0 || empty($_GET['PAGE'])){	$OFFSET = 0;	$PAGE = 1;}else{	$PAGE = intval($_GET['PAGE']);	$OFFSET = ($PAGE - 1) * $system->SETTINGS['perpage'];}$PAGES = ($TOTALAUCTIONS == 0) ? 1 : ceil($TOTALAUCTIONS / $system->SETTINGS['perpage']);// Handle columns sorting variablesif (!isset($_SESSION['pa_ord']) && empty($_GET['pa_ord'])){	$_SESSION['pa_ord'] = 'title';	$_SESSION['pa_type'] = 'asc';}elseif (!empty($_GET['pa_ord'])){	$_SESSION['pa_ord'] = $_GET['pa_ord'];	$_SESSION['pa_type'] = $_GET['pa_type'];}elseif (isset($_SESSION['pa_ord']) && empty($_GET['pa_ord'])){	$_SESSION['pa_nexttype'] = $_SESSION['pa_type'];}if (!isset($_SESSION['pa_nexttype']) || $_SESSION['pa_nexttype'] == 'desc'){	$_SESSION['pa_nexttype'] = 'asc';}else{	$_SESSION['pa_nexttype'] = 'desc';}if (!isset($_SESSION['pa_type']) || $_SESSION['pa_type'] == 'desc'){	$_SESSION['pa_type_img'] = '<img src="images/arrow_up.gif" align="center" hspace="2" border="0" />';}else{	$_SESSION['pa_type_img'] = '<img src="images/arrow_down.gif" align="center" hspace="2" border="0" />';}$query = "SELECT * FROM " . $DBPrefix . "auctions au	WHERE user = :user_id AND starts > :now AND suspended = :suspend	ORDER BY " . $_SESSION['pa_ord'] . " " . $_SESSION['pa_type'] . " LIMIT :offset, :perpage";$params = array(	array(':user_id', $user->user_data['id'], 'int'),	array(':now', $NOW, 'int'),	array(':suspend', 0, 'int'),	array(':offset', $OFFSET, 'int'),	array(':perpage', $system->SETTINGS['perpage'], 'int'));$db->query($query, $params);$i = 0;while ($item = $db->result()){	$template->assign_block_vars('items', array(			'BGCOLOR' => (!($i % 2)) ? '' : 'class="alt-row"',			'ID' => $item['id'],			'TITLE' => $item['title'],			'STARTS' => $system->dateToTimestamp($item['starts']),			'ENDS' => $system->dateToTimestamp($item['ends']),			'SEO_TITLE' => generate_seo_link($item['title']),			'B_HASNOBIDS' => ($item['current_bid'] == 0)			));	$i++;}// get pagenation$PREV = intval($PAGE - 1);$NEXT = intval($PAGE + 1);if ($PAGES > 1){	$LOW = $PAGE - 5;	if ($LOW <= 0) $LOW = 1;	$COUNTER = $LOW;	while ($COUNTER <= $PAGES && $COUNTER < ($PAGE + 6))	{		$template->assign_block_vars('pages', array(				'PAGE' => ($PAGE == $COUNTER) ? '<li class="disabled"><a href="#">' . $COUNTER . '</a></li>' : '<li><a href="' . $system->SETTINGS['siteurl'] . 'yourauctions_p.php?PAGE=' . $COUNTER . '">' . $COUNTER . '</a></li>'				));		$COUNTER++;	}}$template->assign_vars(array(	'BGCOLOR' => (!($i % 2)) ? '' : 'class="alt-row"',	'ORDERCOL' => $_SESSION['pa_ord'],	'ORDERNEXT' => $_SESSION['pa_nexttype'],	'ORDERTYPEIMG' => $_SESSION['pa_type_img'],	'PREV' => ($PAGES > 1 && $PAGE > 1) ? '<a href="' . $system->SETTINGS['siteurl'] . 'yourauctions_p.php?PAGE=' . $PREV . '">' . $MSG['5119'] . '</a>' : '',	'NEXT' => ($PAGE < $PAGES) ? '<a href="' . $system->SETTINGS['siteurl'] . 'yourauctions_p.php?PAGE=' . $NEXT . '">' . $MSG['5120'] . '</a>' : '',	'PAGE' => $PAGE,	'PAGES' => $PAGES,	'B_AREITEMS' => ($i > 0),	'ACTIVESELLINGTAB' => 'class="active"',	'ACTIVEPENDINGAUCTIONS' => 'class="active"',	'ACTIVESELLINGPANEL' => 'active'));include 'header.php';$template->set_filenames(array(		'body' => 'yourauctions_p.tpl'		));$template->display('body');include 'footer.php';