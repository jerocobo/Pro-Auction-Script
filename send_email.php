<?php/******************************************************************************* *   copyright				: (C) 2014 - 2018 Pro-Auction-Script *   site					: https://www.pro-auction-script.com *   Script License			: https://www.pro-auction-script.com/contents.php?show=free_license *******************************************************************************/include 'common.php';if (($system->SETTINGS['contactseller'] == 'logged' && !$user->checkAuth()) || $system->SETTINGS['contactseller'] == 'never'){	if (isset($_SESSION['REDIRECT_AFTER_LOGIN']))	{		header('location: ' . $_SESSION['REDIRECT_AFTER_LOGIN']);	}	else	{		header('location: home');	}}if (!isset($_POST['auction_id']) && !isset($_GET['auction_id'])){	$auction_id = intval($_SESSION['CURRENT_ITEM']);}else{	$auction_id = intval($_GET['auction_id']);}$_SESSION['CURRENT_ITEM'] = $auction_id;// Get item description$query = "SELECT a.user, a.title, u.nick, u.email FROM " . $DBPrefix . "auctions a	LEFT JOIN " . $DBPrefix . "users u ON (u.id = a.user)	WHERE a.id = :auc_id";$params = array(	array(':auc_id', $auction_id, 'int'));$db->query($query, $params);if ($db->numrows() == 0){	$TPL_error_text = $ERR['606'];}else{	$auctionData = $db->result();	$sellerID = $auctionData['user'];	$itemTitle = $auctionData['title'];	$sellerNick = $auctionData['nick'];	$sellerEmail = $auctionData['email'];}if ($user->checkAuth()){	header('location: ' . $system->SETTINGS['siteurl'] . 'email_request.php?user_id=' . $sellerID . '&username=' . $sellerNick . '&auction_id=' . $auction_id);	exit;}if($user->logged_in){	$senderEmail = $user->user_data['email'];	$senderName = $user->user_data['name'];	$from_id = $user->user_data['id'];}else{	$senderEmail = $_POST['senderEmail'];	$senderName = $_POST['senderName'];	$from_id = 0;}if (isset($_POST['action']) || !empty($_POST['action'])){	$cleaned_question = stripslashes($system->cleanvars($_POST['senderQuestion']));	if ($system->SETTINGS['wordsfilter'] == 'y')	{		$cleaned_question = stripslashes($system->filter($cleaned_question));	}	// Check errors	if (isset($_POST['action']) && (empty($senderName) || empty($senderEmail) || empty($sellerNick) || empty($sellerEmail)))	{		$TPL_error_text = $ERR['032'];	}	if (empty($cleaned_question))	{		$TPL_error_text = $ERR['031'];	}	if (preg_match('/@.+\./', $email) && (!filter_var($senderEmail, FILTER_VALIDATE_EMAIL) || !filter_var($sellerEmail, FILTER_VALIDATE_EMAIL)))	{		$TPL_error_text = $ERR['008'];	}	if (empty($TPL_error_text))	{		$optionSettings = array(				'userID' => $sellerID,			);		$smsAlerts->alertSettingHandler('newMessageAlert',$optionSettings);		$mes = $send_email->auction_question($senderName, $cleaned_question, $senderEmail, $auction_id, $itemTitle, $sellerNick, $sellerID, $sellerEmail);		$query = "INSERT INTO " . $DBPrefix . "messages VALUES (NULL, :seller_id, :from_id, :from_email, :timer, :question, 0, :title, 0, 0, :auc_id, 0)";		$params = array(			array(':seller_id', $sellerID, 'int'),			array(':from_id', $from_id, 'int'),			array(':from_email', $senderEmail, 'str'),			array(':timer', $system->CTIME, 'int'),			array(':question', $cleaned_question, 'str'),			array(':title', $system->cleanvars(sprintf($MSG['651'], $itemTitle)), 'str'),			array(':auc_id', $auction_id, 'int')		);		$db->query($query, $params);	}}$template->assign_vars(array(	'SEOLINK' => generate_seo_link($itemTitle),	'MESSAGE' => (isset($mes)) ? $mes : '',	'ERROR' => (isset($TPL_error_text)) ? $TPL_error_text : '',	'AUCT_ID' => $auction_id,	'SELLER_NICK' => $sellerNick,	'SELLER_EMAIL' => $sellerEmail,	'SELLER_QUESTION' => (isset($_POST['senderQuestion'])) ? $_POST['senderQuestion'] : '',	'ITEM_TITLE' => $itemTitle,	'EMAIL' => ($user->logged_in) ? $user->user_data['email'] : ''));include 'header.php';$template->set_filenames(array(		'body' => 'send_email.tpl'		));$template->display('body');include 'footer.php';