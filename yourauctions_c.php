<?php/******************************************************************************* *   copyright				: (C) 2014 - 2018 Pro-Auction-Script *   site					: https://www.pro-auction-script.com *   Script License			: https://www.pro-auction-script.com/contents.php?show=free_license *******************************************************************************/include 'common.php';// If user is not logged in redirect to login pageif (!$user->logged_in){	$_SESSION['REDIRECT_AFTER_LOGIN'] = 'yourauctions_c.php';	header('location: user_login.php');	exit;}// DELETE OPEN AUCTIONS$NOW = $system->CTIME;$NOWB = date('Ymd');$catscontrol = new MPTTcategories();$query = "SELECT value FROM " . $DBPrefix . "fees WHERE type = :type";$params = array(	array(':type', 'relist_fee', 'str'));$db->query($query, $params);$relist_fee = $db->result('value');// Updateif (isset($_POST['action']) && $_POST['action'] == 'update'){	// Delete auction	if (is_array($_POST['delete']))	{		foreach ($_POST['delete'] as $k => $v)		{			$v = intval($v);			// Pictures Gallery			if(is_dir(UPLOAD_PATH . $v))			{				if ($dir = @opendir(UPLOAD_PATH . $v))				{					while ($file = readdir($dir))					{						if ($file != '.' && $file != '..')						{							unlink(UPLOAD_PATH . $v . '/' . $file);						}					}					closedir($dir);					@rmdir(UPLOAD_PATH . $v);				}			}						$system->writesetting("counters", "closedauctions",  $system->COUNTERS['closedauctions'] - 1, 'int');			$query = "DELETE FROM " . $DBPrefix . "auccounter WHERE auction_id = :auc_id";			$params = array(				array(':auc_id', $v, 'int')			);			$db->query($query, $params);			$query = "DELETE FROM " . $DBPrefix . "auctions WHERE id = :auc_id";			$params = array(				array(':auc_id', $v, 'int')			);			$db->query($query, $params);			$query = "DELETE FROM " . $DBPrefix . "bids WHERE auction = :auc_id";			$params = array(				array(':auc_id', $v, 'int')			);			$db->query($query, $params);			$query = "DELETE FROM " . $DBPrefix . "proxybid WHERE itemid = :auc_id";			$params = array(				array(':auc_id', $v, 'int')			);			$db->query($query, $params);		}	}	if (is_array($_POST['sell']))	{		foreach ($_POST['sell'] as $v)		{			$query = "UPDATE " . $DBPrefix . "auctions SET sold = :sold WHERE id = :auc_id";			$params = array(				array(':sold', 's', 'str'),				array(':auc_id', $v, 'int')			);			$db->query($query, $params);		}		include 'cron.php';	}	// Re-list auctions	if (is_array($_POST['relist']))	{		foreach ($_POST['relist'] as $k)		{			$k = intval($k);			$query = "SELECT duration, category FROM " . $DBPrefix . "auctions WHERE id = :auc_id";			$params = array(				array(':auc_id', $k, 'int')			);			$db->query($query, $params);			$AUCTION = $db->result();			// auction ends			$WILLEND = $system->CTIME + ($AUCTION['duration'] * 24 * 60 * 60);			$suspend = 0;			if ($system->SETTINGS['fees'] == 'y')			{				if ($system->SETTINGS['fee_type'] == 1)				{					// charge relist fee					$query = "UPDATE " . $DBPrefix . "users SET balance = balance - :relist WHERE id = :user_id";					$params = array(						array(':relist', $relist_fee, 'float'),						array(':user_id', $user->user_data['id'], 'int')					);					$db->query($query, $params);				}				else				{					$suspend = 8;				}			}			$query = "UPDATE " . $DBPrefix . "auctions				  SET starts = :now,				  ends = :ends,				  closed = :close,				  num_bids = :num_bid,				  relisted = relisted + :relist,				  current_bid = :current_bids,				  sold = :no_sold,				  suspended = :suspend				  WHERE id = :auc_id";			$params = array(				array(':now', $NOW, 'int'),				array(':ends', $WILLEND, 'int'),				array(':close', 0, 'int'),				array(':num_bid', 0, 'int'),				array(':relist', 1, 'int'),				array(':current_bids', 0, 'int'),				array(':no_sold', 'n', 'str'),				array(':suspend', $suspend, 'int'),				array(':auc_id', $k, 'int')			);			$db->query($query, $params);			// Insert into relisted table			$query = "INSERT INTO " . $DBPrefix . "closedrelisted VALUES (:auc_id, :relist, :new_auc_id)";			$params = array(				array(':auc_id', $k, 'int'),				array(':relist', $NOWB, 'int'),				array(':new_auc_id', $k, 'int')			);			$db->query($query, $params);			// delete bids			$query = "DELETE FROM " . $DBPrefix . "bids WHERE auction = :auc_id";			$params = array(				array(':auc_id', $k, 'int')			);			$db->query($query, $params);			// Proxy Bids			$query = "DELETE FROM " . $DBPrefix . "proxybid WHERE itemid = :auc_id";			$params = array(				array(':auc_id', $k, 'int')			);			$db->query($query, $params);			// Update COUNTERS table			$system->writesetting("counters", "auctions", $system->COUNTERS['auctions'] + 1, 'int');			$query = "SELECT left_id, right_id, level FROM " . $DBPrefix . "categories WHERE cat_id = :cat_ids";			$params = array(				array(':cat_ids', $AUCTION['category'], 'int')			);			$db->query($query, $params);			$parent_node = $db->fetchall();			$crumbs = $catscontrol->get_bread_crumbs($parent_node['left_id'], $parent_node['right_id']);			// update recursive categories			for ($i = 0; $i < count($crumbs); $i++)			{				$query = "UPDATE " . $DBPrefix . "categories SET sub_counter = sub_counter + :sub WHERE cat_id = :cat_ids";				$params = array(					array(':sub', 1, 'int'),					array(':cat_ids', $crumbs[$i]['cat_id'], 'int')				);				$db->query($query, $params);			}			if ($system->SETTINGS['fee_type'] == 2 && isset($relist_fee) && $relist_fee > 0)			{				header('location: pay.php?a=5');				exit;			}		}	}}// Retrieve closed auction data from the database$query = "SELECT COUNT(id) AS COUNT FROM " . $DBPrefix . "auctions	WHERE user = :user_id 	AND closed = :close AND suspended = :suspend	AND (num_bids = :bids OR (num_bids > :count_bids AND current_bid < reserve_price AND sold = :item_sold))";$params = array(	array(':user_id', $user->user_data['id'], 'int'),	array(':close', 1, 'int'),	array(':suspend', 0, 'int'),	array(':bids', 0, 'int'),	array(':count_bids', 0, 'int'),	array(':item_sold', 'n', 'str'));$db->query($query, $params);$TOTALAUCTIONS = $db->result('COUNT');if (!isset($_GET['PAGE']) || $_GET['PAGE'] == 1){	$OFFSET = 0;	$PAGE = 1;}else{	$PAGE = intval($_GET['PAGE']);	$OFFSET = ($PAGE - 1) * $system->SETTINGS['perpage'];}$PAGES = ($TOTALAUCTIONS == 0) ? 1 : ceil($TOTALAUCTIONS / $system->SETTINGS['perpage']);// Handle columns sorting variablesif (!isset($_SESSION['ca_ord']) && empty($_GET['ca_ord'])){	$_SESSION['ca_ord'] = 'title';	$_SESSION['ca_type'] = 'asc';}elseif (!empty($_GET['ca_ord'])){	$_SESSION['ca_ord'] = $_GET['ca_ord'];	$_SESSION['ca_type'] = $_GET['ca_type'];}elseif (isset($_SESSION['ca_ord']) && empty($_GET['ca_ord'])){	$_SESSION['ca_nexttype'] = $_SESSION['ca_type'];}if (!isset($_SESSION['ca_nexttype']) || $_SESSION['ca_nexttype'] == 'desc'){	$_SESSION['ca_nexttype'] = 'asc';}else{	$_SESSION['ca_nexttype'] = 'desc';}if (!isset($_SESSION['ca_type']) || $_SESSION['ca_type'] == 'desc'){	$_SESSION['ca_type_img'] = '<img src="images/arrow_up.gif" align="center" hspace="2" border="0">';}else{	$_SESSION['ca_type_img'] = '<img src="images/arrow_down.gif" align="center" hspace="2" border="0">';}$query = "SELECT * FROM " . $DBPrefix . "auctions WHERE user = :user_id	AND closed = :close AND suspended = :suspend	AND (num_bids = :bids OR (num_bids > :count_bids AND reserve_price > :reserve AND current_bid < reserve_price AND sold = :item_sold))	ORDER BY " . $_SESSION['ca_ord'] . " " . $_SESSION['ca_type'] . " LIMIT " . $OFFSET . ", " . $system->SETTINGS['perpage'];$params = array(	array(':user_id', $user->user_data['id'], 'int'),	array(':close', 1, 'int'),	array(':suspend', 0, 'int'),	array(':bids', 0, 'int'),	array(':count_bids', 0, 'int'),	array(':reserve', 0, 'int'),	array(':item_sold', 'n', 'str'));$db->query($query, $params);$i = 0;while ($item = $db->result()){	$canrelist = false;	if (($item['current_bid'] > $item['reserve_price']))	{		$cansell = false;	}	else	{		if ($item['reserve_price'] > 0 || $item['num_bids'] == 0)		{			$canrelist = true;		}		if ($item['reserve_price'] > 0 && $item['num_bids'] > 0)		{			$cansell = true;		}		else		{			$cansell = false;		}	}	$template->assign_block_vars('items', array(			'BGCOLOR' => (!($i % 2)) ? '' : 'class="alt-row"',			'ID' => $item['id'],			'TITLE' => $item['title'],			'STARTS' => $system->dateToTimestamp($item['starts']),			'ENDS' => $system->dateToTimestamp($item['ends']),			'BID' => ($item['current_bid'] == 0) ? '-' : $system->print_money($item['current_bid']),			'BIDS' => $item['num_bids'],			'SEO_TITLE' => generate_seo_link($item['title']),			'B_CANRELIST' => $canrelist,			'B_CANSSELL' => $cansell,			'B_HASNOBIDS' => ($item['current_bid'] == 0)			));	$i++;}// get pagenation$PREV = intval($PAGE - 1);$NEXT = intval($PAGE + 1);if ($PAGES > 1){	$LOW = $PAGE - 5;	if ($LOW <= 0) $LOW = 1;	$COUNTER = $LOW;	while ($COUNTER <= $PAGES && $COUNTER < ($PAGE + 6))	{		$template->assign_block_vars('pages', array(				'PAGE' => ($PAGE == $COUNTER) ? '<li class="disabled"><a href="#">' . $COUNTER . '</a></li>' : '<li><a href="' . $system->SETTINGS['siteurl'] . 'yourauctions_c.php?PAGE=' . $COUNTER . '">' . $COUNTER . '</a></li>'				));		$COUNTER++;	}}$template->assign_vars(array(	'BGCOLOR' => (!($i % 2)) ? '' : 'class="alt-row"',	'ORDERCOL' => $_SESSION['ca_ord'],	'ORDERNEXT' => $_SESSION['ca_nexttype'],	'ORDERTYPEIMG' => $_SESSION['ca_type_img'],	'RELIST_FEE' => $system->print_money($relist_fee),	'RELIST_FEE_NO' => $system->print_money_nosymbol($relist_fee),	'PREV' => ($PAGES > 1 && $PAGE > 1) ? '<a href="' . $system->SETTINGS['siteurl'] . 'yourauctions_c.php?PAGE=' . $PREV . '">' . $MSG['5119'] . '</a>' : '',	'NEXT' => ($PAGE < $PAGES) ? '<a href="' . $system->SETTINGS['siteurl'] . 'yourauctions_c.php?PAGE=' . $NEXT . '">' . $MSG['5120'] . '</a>' : '',	'PAGE' => $PAGE,	'PAGES' => $PAGES,	'B_AREITEMS' => ($i > 0),	'B_RELIST_FEE' => ($relist_fee > 0 && $system->SETTINGS['fees'] == 'y'),	'B_AUTORELIST' => ($system->SETTINGS['autorelist'] == 'y'),	'ACTIVESELLINGTAB' => 'class="active"',	'ACTIVECLOSEDAUCTIONS' => 'class="active"',	'ACTIVESELLINGPANEL' => 'active'));include 'header.php';$template->set_filenames(array(		'body' => 'yourauctions_c.tpl'		));$template->display('body');include 'footer.php';