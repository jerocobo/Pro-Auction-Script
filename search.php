<?php/******************************************************************************* *   copyright				: (C) 2014 - 2018 Pro-Auction-Script *   site					: https://www.pro-auction-script.com *   Script License			: https://www.pro-auction-script.com/contents.php?show=free_license *******************************************************************************/include 'common.php';$NOW = $system->CTIME;$term = isset($_GET['q']) ? trim($_GET['q']) : '';$cat_id = isset($_GET['id']) ? intval($_GET['id']) : '';if (strlen($term) == 0){	$ERROR = $ERR['037'];	$template->assign_vars(array(		'NUM_AUCTIONS' => 0,		'TOP_HTML' => ''	));}else{	$catSQL = '';	if ($cat_id < 0)	{		$catscontrol = new MPTTcategories();		$query = "SELECT right_id, left_id FROM " . $DBPrefix . "categories WHERE cat_id = :cat_id";		$params = array(			array(':cat_id', $cat_id, 'int')		);		$db->query($query, $params);		$parent_node = $db->result();		$children = $catscontrol->get_children_list($parent_node['left_id'], $parent_node['right_id']);		$childarray = array($cat_id);		foreach ($children as $k => $v)		{			$childarray[] = $v['cat_id'];		}		$catalist = '(';		$catalist .= implode(',', $childarray);		$catalist .= ')';		$catSQL = " AND (category IN " . $catalist;		if ($system->SETTINGS['extra_cat'] == 'y')		{			$catSQL .= " OR secondcat IN " . $catalist;		}		$catSQL .= ")";	}		$query = "SELECT * FROM " . $DBPrefix . "auctions WHERE			(title LIKE :title OR id = :auc_id) " . $catSQL . " AND (closed = 1 OR closed = 0) AND suspended = 0 AND starts < :stime AND ends > :etime";	$params = array(		array(':title', '%' . $system->cleanvars($term) . '%', 'str'),		array(':auc_id', $term, 'int'),		array(':stime', $NOW, 'int'),		array(':etime', $NOW, 'int')	);	$db->query($query, $params);	// get total number of records	$total = $db->numrows();	// retrieve records corresponding to passed page number	$PAGE = isset($_GET['PAGE']) ? intval($_GET['PAGE']) : 1;	if ($PAGE == 0) $PAGE = 1;	// determine limits for SQL query	$left_limit = ($PAGE - 1) * $system->SETTINGS['perpage'];	// get number of pages	$PAGES = ceil($total / $system->SETTINGS['perpage']);	$query_feat = $query . " AND featured = 'y' ORDER BY ends LIMIT :offset, 5";	$params_feat = $params;	$params_feat[] = array(':offset', (($PAGE - 1) * 5), 'int');	$query = $query . " ORDER BY ends LIMIT :offset, :perpage";	$params[] = array(':offset', $left_limit, 'int');	$params[] = array(':perpage', $system->SETTINGS['perpage'], 'int');	// to be sure about items format, I've unified the call	include INCLUDE_PATH . 'browseitems.inc.php';	browseItems($query, $params, $query_feat, $params_feat, $total, 'search.php', 'q=' . $term . '&id=' . $cat_id);}$template->assign_vars(array(	'ERROR' => isset($ERROR) ? $ERROR : ''));include 'header.php';$template->set_filenames(array(		'body' => 'search.tpl'		));$template->display('body');include 'footer.php';