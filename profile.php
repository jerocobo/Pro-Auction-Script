<?php/******************************************************************************* *   copyright				: (C) 2014 - 2018 Pro-Auction-Script *   site					: https://www.pro-auction-script.com *   Script License			: https://www.pro-auction-script.com/contents.php?show=free_license *******************************************************************************/include 'common.php';include INCLUDE_PATH . 'membertypes.inc.php';foreach ($membertypes as $idm => $memtypearr){	$memtypesarr[$memtypearr['feedbacks']] = $memtypearr;}ksort($memtypesarr, SORT_NUMERIC);if(!isset($_GET['user_id'])){	$_GET['user_id'] = $user->user_data['id'];}$auctionID = '';if (!empty($_GET['auction_id'])){	$auctionID = $_GET['auction_id'];	$query = "SELECT title FROM " . $DBPrefix . "auctions WHERE id = :auc_id";	$params = array(		array(':auc_id', $auctionID, 'int')	);			$db->query($query, $params);	$title = $db->result('title');}if (!empty($_GET['user_id'])){	$query = "SELECT * FROM " . $DBPrefix . "users WHERE id = :user_id";	$params = array(		array(':user_id', $_GET['user_id'], 'int')	);	$db->query($query, $params);}if (@$db->numrows() == 1){	$arr = $db->result();	$TPL_user_id = $arr['id'];	$TPL_rate_ratio_value = '';	foreach ($memtypesarr as $k => $l)	{		if ($k >= $arr['rate_sum'] || $i++ == (count($memtypesarr) - 1))		{			$TPL_rate_ratio_value = '<img src="' . $system->SETTINGS['siteurl'] . 'images/icons/' . $l['icon'] . '" alt="' . $l['icon'] . '" class="fbstar">';			break;		}	}	$query = "SELECT f.*, a.user FROM " . $DBPrefix . "feedbacks f		LEFT JOIN " . $DBPrefix . "auctions a ON (a.id = f.auction_id)		WHERE f.rated_user_id = :user_id";	$params = array(		array(':user_id', $TPL_user_id, 'int')	);	$db->query($query, $params);	$total_fb = 0;	$fb = array(-1 => 0, 0 => 0, 1 => 0);	$fb_as_seller = array(-1 => 0, 0 => 0, 1 => 0);	$fb_as_buyer = array(-1 => 0, 0 => 0, 1 => 0);	$fb_last_year = array(-1 => 0, 0 => 0, 1 => 0);	$fb_last_3month = array(-1 => 0, 0 => 0, 1 => 0);	$fb_last_month = array(-1 => 0, 0 => 0, 1 => 0);	if ($db->numrows() > 0)	{		while ($ratesum = $db->result())		{			$fb[$ratesum['rate']]++;			$total_fb++;			if ($ratesum['user'] == $TPL_user_id)			{				$fb_as_seller[$ratesum['rate']]++;			}			else			{				$fb_as_buyer[$ratesum['rate']]++;			}			if ($ratesum['feedbackdate'] > $system->CTIME - (3600 * 24 * 365))			{				$fb_last_year[$ratesum['rate']]++;			}			if ($ratesum['feedbackdate'] > $system->CTIME - (3600 * 24 * 90))			{				$fb_last_3month[$ratesum['rate']]++;			}			if ($ratesum['feedbackdate'] > $system->CTIME - (3600 * 24 * 30))			{				$fb_last_month[$ratesum['rate']]++;			}		}	}		// User Online Status	$loggedtime = $system->CTIME - 320; // 5 min	$query = "SELECT is_online, hideOnline FROM " . $DBPrefix . "users WHERE id = :user_id"; 	$params = array(		array(':user_id', $TPL_user_id, 'int')	);	$db->query($query, $params);	while ($onlinecheck = $db->result()) 	{ 		    if($onlinecheck['is_online'] > $loggedtime && $onlinecheck['hideOnline'] == 'n')	    { 	    $online = true;	    } 	    else { 	    $online = false;	    }     	} 	$DATE = $arr['reg_date'] + $system->TDIFF;	$mth = 'MON_0'.date('m', $DATE);	$feedback_rate = ($arr['rate_sum'] == 0) ? 1 : $arr['rate_sum'];	$feedback_rate = ($feedback_rate < 0) ? $feedback_rate * - 1 : $feedback_rate;	$total_fb = ($total_fb < 1) ? 1 : $total_fb;	$variables = array(		'RATE_VAL' => $TPL_rate_ratio_value,		'NUM_FB' => $arr['rate_num'],		'SUM_FB' => $arr['rate_sum'],		'FB_POS' => (isset($fb[1])) ? '<span style="color:green"><b>' . $MSG['500'] . '</b>' . $fb[1] . ' (' . ceil($fb[1] * 100 / $total_fb) . '%)</span><br>' : '',		'FB_NEUT' => (isset($fb[0])) ? '<b>' . $MSG['499'] . '</b>' . $fb[0] . ' (' . ceil($fb[0] * 100 / $total_fb) . '%)<br>' : '',		'FB_NEG' => (isset($fb[ - 1])) ? '<span style="color:red"><b>' . $MSG['501'] . '</b>' . $fb[ - 1] . ' (' . ceil($fb[ - 1] * 100 / $total_fb) . '%)</span>' : '',		'FB_SELLER_POS' => $fb_as_seller[1],		'FB_BUYER_POS' => $fb_as_buyer[1],		'FB_LASTYEAR_POS' => $fb_last_year[1],		'FB_LAST3MONTH_POS' => $fb_last_3month[1],		'FB_LASTMONTH_POS' => $fb_last_month[1],		'FB_SELLER_NEUT' => $fb_as_seller[0],		'FB_BUYER_NEUT' => $fb_as_buyer[0],		'FB_LASTYEAR_NEUT' => $fb_last_year[0],		'FB_LAST3MONTH_NEUT' => $fb_last_3month[0],		'FB_LASTMONTH_NEUT' => $fb_last_month[0],		'FB_SELLER_NEG' => $fb_as_seller[-1],		'FB_BUYER_NEG' => $fb_as_buyer[-1],		'FB_LASTYEAR_NEG' => $fb_last_year[-1],		'FB_LAST3MONTH_NEG' => $fb_last_3month[-1],		'FB_LASTMONTH_NEG' => $fb_last_month[-1],		'REGSINCE' => $MSG[$mth].' '.date('d, Y', $DATE),		'COUNTRY' => $arr['country'],		'IS_ONLINE' => $online,		'BACK_TO_AUCTION' => $auctionID !='' ? $system->SETTINGS['siteurl'] . 'products/' . generate_seo_link($title) . '-' . $auctionID : '',		'AUCTION_ID' => ($auctionID !='') ? $auctionID : '',		'USER' => $arr['nick'],		'USER_ID' => $TPL_user_id,		'B_VIEW' => true,		'B_FB_LINK' => 'IndexFBLogin',		'B_AUCID' => ($auctionID !='' ? true : false),		'B_CONTACT' => (($system->SETTINGS['contactseller'] == 'always' || ($system->SETTINGS['contactseller'] == 'logged' && $user->logged_in)) && (!$user->logged_in || $user->user_data['id'] != $TPL_user_id))		);}else{	$variables = array(		'B_VIEW' => false,		'MSG' => $ERR['025']		);}$query = "SELECT avatar FROM " . $DBPrefix . "users WHERE id = :user_id";$params = array(	array(':user_id', $TPL_user_id, 'int'));$db->query($query, $params);$TPL_avatar = $db->result('avatar');$template->assign_vars(array('AVATAR' => $TPL_avatar,));  $template->assign_vars($variables);include 'header.php';$template->set_filenames(array(		'body' => 'profile.tpl'		));$template->display('body');include 'footer.php';